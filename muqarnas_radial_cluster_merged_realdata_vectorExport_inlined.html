<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Muqarnas Transmission — Radial Cluster (Merged Database)</title>
<style>
  html, body { height: 100%; margin: 0; background: #fafafa; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:#111; }
  #wrap { height: 100%; display: grid; grid-template-rows: auto 1fr; }
  header { display:flex; align-items:center; gap:12px; padding:12px 14px; border-bottom:1px solid #e8e8e8; background: rgba(250,250,250,0.92); backdrop-filter: blur(6px); }
  header .title { font-weight: 750; letter-spacing:.2px; }
  header .hint { color:#666; font-size:12px; }
  #search { margin-left:auto; display:flex; gap:8px; align-items:center; }
  #q { width: 380px; max-width: 46vw; padding:10px 12px; border-radius: 12px; border:1px solid #ddd; outline:none; background:#fff; }
  button { padding:10px 12px; border-radius: 12px; border:1px solid #ddd; background:#fff; cursor:pointer; }
  button:hover { background:#f3f3f3; }
  #stage { position:relative; overflow:hidden; }
  svg { width:100%; height:100%; }

  :root{
    --ink: rgba(0,0,0,0.28);
    --ink-dim: rgba(0,0,0,0.06);
    --west: rgba(201,183,154,0.85);   /* warm sand */
    --west-line: rgba(201,183,154,0.55);
    --central: rgba(107,143,179,0.90); /* slate blue */
    --central-line: rgba(107,143,179,0.55);
  }
  .link { fill:none; stroke: var(--ink); stroke-linecap: round; }
  .link.dim { stroke: var(--ink-dim); }
  .link.west { stroke: var(--west-line); }
  .link.central { stroke: var(--central-line); }
  .link.west.dim, .link.central.dim { stroke: rgba(0,0,0,0.06); }

  .node.west circle { fill: var(--west); }
  .node.central circle { fill: var(--central); }

  /* keep labels mostly black, but gently tinted for country nodes */
  .node.west.country text.label { fill: rgba(120,92,60,0.82); }
  .node.central.country text.label { fill: rgba(40,70,110,0.82); }

  .link { fill:none; stroke: rgba(0,0,0,0.28); stroke-linecap: round; }
  .link.dim { stroke: rgba(0,0,0,0.06); }
  .node circle { fill:#111; }
  .label { font-size: 14px; fill: rgba(0,0,0,0.84); }
  .label.dim { fill: rgba(0,0,0,0.30); }
  .bar { fill: rgba(0,0,0,0.28); }
  .bar-bg { fill: rgba(0,0,0,0.08); }
  .tooltip { position:absolute; pointer-events:none; background: rgba(20,20,20,0.92); color:#fff; padding:10px 12px; border-radius:12px; font-size:12px; line-height:1.25; max-width:460px; box-shadow:0 10px 30px rgba(0,0,0,0.18); opacity:0; transition: opacity .12s ease; }
  .tooltip strong { display:block; margin-bottom:6px; font-size:13px; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background: rgba(255,255,255,0.12); margin-right:6px; margin-top:6px; white-space:nowrap; }
  .tooltip a { color: rgba(255,255,255,0.92); text-decoration: underline; word-break: break-all; }
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="title">Muqarnas Transmission — Radial Cluster</div>
    <div class="hint">Merged Excel → Iran → Style → Country → Building · Leaf bars = Complexity</div>
    <div id="search">
      <input id="q" placeholder="Search building / country / style..." />
      <button id="clear">Clear</button>
      <button id="reset">Reset View</button>
    <button id="export4k">Download 4K PNG</button>
      <button id="exportSVG">Download SVG</button>
    </div>
  </header>
  <div id="stage">
    <div class="tooltip" id="tip"></div>
    <svg id="svg"></svg>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7">
// --- 4K Export ---
document.getElementById("export4k").addEventListener("click", function() {
  const svgNode = document.querySelector("svg");
  const serializer = new XMLSerializer();
  const svgString = serializer.serializeToString(svgNode);

  const canvas = document.createElement("canvas");
  const size = 4096;
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");

  const img = new Image();
  const blob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  img.onload = function() {
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, size, size);
    ctx.drawImage(img, 0, 0, size, size);
    URL.revokeObjectURL(url);

    const pngUrl = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = pngUrl;
    a.download = "muqarnas_radial_4k.png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  img.src = url;
});


// --- SVG Export (Vector, with inlined styles) ---
document.getElementById("exportSVG").addEventListener("click", function() {
  const svgNode = document.querySelector("svg");
  const serializer = new XMLSerializer();

  // Clone so we can safely modify
  const clone = svgNode.cloneNode(true);

  // Inline computed styles onto relevant elements so Illustrator/Inkscape preserve colors.
  function inlineStyles(selector, props) {
    const orig = svgNode.querySelectorAll(selector);
    const copy = clone.querySelectorAll(selector);
    for (let i = 0; i < orig.length; i++) {
      const cs = window.getComputedStyle(orig[i]);
      props.forEach(p => {
        const v = cs.getPropertyValue(p);
        if (v && v !== "none" && v !== "normal" && v !== "auto") {
          copy[i].setAttribute(p.replace(/-/g, "_"), v.trim()); // temp store
        }
      });
      // Map temp attrs to SVG presentation attrs
      const o = copy[i];
      if (o.getAttribute("stroke")) o.setAttribute("stroke", o.getAttribute("stroke"));
    }
  }

  // Helper to set SVG presentation attributes from computed styles
  function applyComputed(elOrig, elCopy) {
    const cs = window.getComputedStyle(elOrig);
    const stroke = cs.getPropertyValue("stroke");
    const fill = cs.getPropertyValue("fill");
    const sw = cs.getPropertyValue("stroke-width");
    const op = cs.getPropertyValue("opacity");
    const fo = cs.getPropertyValue("fill-opacity");
    const so = cs.getPropertyValue("stroke-opacity");
    const ff = cs.getPropertyValue("font-family");
    const fs = cs.getPropertyValue("font-size");
    const fw = cs.getPropertyValue("font-weight");

    if (stroke && stroke !== "none") elCopy.setAttribute("stroke", stroke.trim());
    if (fill && fill !== "none") elCopy.setAttribute("fill", fill.trim());
    if (sw && sw !== "0px") elCopy.setAttribute("stroke-width", sw.trim());
    if (op) elCopy.setAttribute("opacity", op.trim());
    if (fo) elCopy.setAttribute("fill-opacity", fo.trim());
    if (so) elCopy.setAttribute("stroke-opacity", so.trim());
    if (ff) elCopy.setAttribute("font-family", ff.trim());
    if (fs) elCopy.setAttribute("font-size", fs.trim());
    if (fw) elCopy.setAttribute("font-weight", fw.trim());
  }

  const selectors = [
    "path.link",
    "g.node circle",
    "g.node text",
    "g.node rect.bar",
    "g.node rect.bar-bg"
  ];

  selectors.forEach(sel => {
    const olist = svgNode.querySelectorAll(sel);
    const clist = clone.querySelectorAll(sel);
    const n = Math.min(olist.length, clist.length);
    for (let i = 0; i < n; i++) {
      applyComputed(olist[i], clist[i]);
    }
  });

  // Ensure XMLNS is present
  clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
  clone.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");

  let svgString = serializer.serializeToString(clone);
  if (!svgString.match(/^<\?xml/)) {
    svgString = '<?xml version="1.0" standalone="no"?>
' + svgString;
  }

  const blob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "muqarnas_radial_vector.svg";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

</script>
<script>
const DATA = {"name": "Iran (Origin)", "children": [{"name": "Abbasid", "children": [{"name": "Iraq", "children": [{"name": "Abbasid Palace", "meta": {"city": "Baghdad", "type": "Palace", "century": "12C", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.4}}, {"name": "Al-Abbasi Palace (Qasr al-Abbasi)", "meta": {"city": "Baghdad", "type": "Palace", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3835"}}, {"name": "Al-Mustansiriya Madrasa", "meta": {"city": "Baghdad", "type": "Madrasa", "century": "13C", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.4}}, {"name": "Great Mosque of Samarra", "meta": {"city": "Samarra", "type": "Mosque", "century": "9C", "structural_vs_decorative": 3, "spatial_depth": 2, "complexity": 2.4}}, {"name": "Qasr al-Abbasi", "meta": {"city": "Baghdad", "type": "Palace", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3835"}}]}]}, {"name": "Alaouite/Modern", "children": [{"name": "Morocco", "children": [{"name": "Great Mosque (Tangier)", "meta": {"city": "Tangier", "type": "Mosque", "century": "19", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/6353"}}]}]}, {"name": "Almohad", "children": [{"name": "Morocco", "children": [{"name": "Jami' al-Hassan (Hasan Mosque)", "meta": {"city": "Rabat", "type": "Mosque", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2557"}}, {"name": "Jami' al-Kabir (Tinmel)", "meta": {"city": "Tinmel", "type": "Mosque", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1745"}}, {"name": "Jami' al-Kabir (Tinmel) - UNESCO tentative site", "meta": {"city": "Marrakech", "type": "Mosque", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1745"}}, {"name": "Jami' al-Kutubiyya (Kutubiyya Mosque)", "meta": {"city": "Marrakech", "type": "Mosque", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1741"}}, {"name": "Masjid Mawlay al-Yazid (Kasbah Mosque)", "meta": {"city": "Marrakech", "type": "Mosque", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1743"}}, {"name": "Tinmal Mosque", "meta": {"city": "Tinmal", "type": "Mosque", "century": "12C", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.4}}]}, {"name": "Spain", "children": [{"name": "Alcazar of Seville", "meta": {"city": "Seville", "type": "Palace", "century": "12–14C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}]}]}, {"name": "Almohad/Marinid", "children": [{"name": "Morocco", "children": [{"name": "Jami' al-Kabir (Taza)", "meta": {"city": "Taza", "type": "Mosque", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/5017"}}]}]}, {"name": "Almoravid", "children": [{"name": "Algeria", "children": [{"name": "Great Mosque of Tlemcen", "meta": {"city": "Tlemcen", "type": "Mosque", "century": "12C", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.4}}]}, {"name": "Morocco", "children": [{"name": "Qubba al-Barudiyyin", "meta": {"city": "Marrakesh", "type": "Shrine", "century": "12C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}]}]}, {"name": "Anatolian Seljuk", "children": [{"name": "Turkey", "children": [{"name": "Gok Medrese", "meta": {"city": "Sivas", "type": "Madrasa", "century": "13C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}]}]}, {"name": "Atabeg (Eldiguzid)", "children": [{"name": "Azerbaijan", "children": [{"name": "Mömina Xatun Mausoleum", "meta": {"city": "Nakhchivan", "type": "Mausoleum", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3693"}}]}]}, {"name": "Ayyubid", "children": [{"name": "Jordan", "children": [{"name": "Ajloun Castle Mosque", "meta": {"city": "Ajloun", "type": "Mosque", "century": "12C", "structural_vs_decorative": 3, "spatial_depth": 3, "complexity": 3.0}}]}, {"name": "Syria", "children": [{"name": "Al-Adiliyya Madrasa", "meta": {"city": "Damascus", "type": "Madrasa", "century": "13C", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.4}}, {"name": "Great Mosque of Aleppo", "meta": {"city": "Aleppo", "type": "Mosque", "century": "12C", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.4}}]}]}, {"name": "Ayyubid/Mamluk", "children": [{"name": "Syria", "children": [{"name": "Madrasa al-Zahiriyya (Aleppo)", "meta": {"city": "Aleppo", "type": "Madrasa", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1826"}}]}]}, {"name": "Contemporary", "children": [{"name": "Oman", "children": [{"name": "Sultan Qaboos Grand Mosque", "meta": {"city": "Muscat", "type": "Mosque", "century": "21C", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 3.2}}]}, {"name": "UAE", "children": [{"name": "Sheikh Zayed Grand Mosque", "meta": {"city": "Abu Dhabi", "type": "Mosque", "century": "21C", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 3.2}}]}]}, {"name": "Deccan Sultanate", "children": [{"name": "India", "children": [{"name": "Ibrahim Rauza", "meta": {"city": "Bijapur", "type": "Mausoleum", "century": "17C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}]}]}, {"name": "Delhi Sultanate", "children": [{"name": "India", "children": [{"name": "Alai Darwaza (Qutb Complex)", "meta": {"city": "Delhi", "type": "Gate", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/5614"}}, {"name": "Qutb Complex", "meta": {"city": "Delhi", "type": "Mosque", "century": "13C", "structural_vs_decorative": 3, "spatial_depth": 3, "complexity": 3.0}}, {"name": "Qutb Minar", "meta": {"city": "Delhi", "type": "Minaret", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2542"}}]}]}, {"name": "Early Islamic", "children": [{"name": "Yemen", "children": [{"name": "Jami' al-Asha'ir", "meta": {"city": "Zabid", "type": "Mosque", "century": "9", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/3812"}}, {"name": "Jami' al-Hadi", "meta": {"city": "Sa'da", "type": "Mosque", "century": "10", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/3805"}}]}]}, {"name": "Fatimid", "children": [{"name": "Egypt", "children": [{"name": "Al-Azhar Mosque", "meta": {"city": "Cairo", "type": "Mosque", "century": "10C", "structural_vs_decorative": 3, "spatial_depth": 3, "complexity": 3.0}}]}]}, {"name": "Ghurid", "children": [{"name": "Afghanistan", "children": [{"name": "Manar-i Ghiyas al-Din (Minaret of Jam)", "meta": {"city": "Jam", "type": "Minaret", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3928"}}, {"name": "Minaret of Jam", "meta": {"city": "Jam", "type": "Minaret", "century": "12C", "structural_vs_decorative": 3, "spatial_depth": 3, "complexity": 3.0}}]}]}, {"name": "Ghurid/Timurid", "children": [{"name": "Afghanistan", "children": [{"name": "Gumbad-i Chisht-i Sharif", "meta": {"city": "Chesht-e Sharif", "type": "Mausoleum", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3927"}}]}]}, {"name": "Hafsid", "children": [{"name": "Tunisia", "children": [{"name": "Great Mosque of Kairouan", "meta": {"city": "Kairouan", "type": "Mosque", "century": "13C", "structural_vs_decorative": 3, "spatial_depth": 2, "complexity": 2.4}}, {"name": "Zitouna Mosque", "meta": {"city": "Tunis", "type": "Mosque", "century": "13C", "structural_vs_decorative": 3, "spatial_depth": 3, "complexity": 3.0}}]}]}, {"name": "Hammadid", "children": [{"name": "Algeria", "children": [{"name": "Qal'a Bani Hammad", "meta": {"city": "Béjaïa region", "type": "Ruined city/Palace complex", "century": "11", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/4028"}}]}]}, {"name": "Ilkhanid", "children": [{"name": "Iran", "children": [{"name": "Jameh Mosque of Varamin", "meta": {"city": "Varamin", "type": "Mosque", "century": "14C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}, {"name": "Masjid-i Jami (Natanz)", "meta": {"city": "Natanz", "type": "Mosque", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1645"}}, {"name": "Masjid-i Jami' (Varamin)", "meta": {"city": "Varamin", "type": "Mosque", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1686"}}, {"name": "Soltaniyeh Dome", "meta": {"city": "Soltaniyeh", "type": "Mausoleum", "century": "14C", "structural_vs_decorative": 5, "spatial_depth": 5, "complexity": 5.0}}]}, {"name": "Turkey", "children": [{"name": "Amasya Bimarhanesi", "meta": {"city": "Amasya", "type": "Hospital", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3611"}}]}]}, {"name": "Ilkhanid/Seljuk", "children": [{"name": "Iran", "children": [{"name": "Mashhad-i Bayazid Bastami", "meta": {"city": "Bastam", "type": "Shrine complex", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1599"}}]}, {"name": "Turkey", "children": [{"name": "Yakutiye Medresesi", "meta": {"city": "Erzurum", "type": "Madrasa", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1952"}}]}]}, {"name": "Jalayirid", "children": [{"name": "Iraq", "children": [{"name": "Madrasa al-Mirjaniyya", "meta": {"city": "Baghdad", "type": "Madrasa", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3844"}}]}]}, {"name": "Local", "children": [{"name": "China", "children": [{"name": "Altun Mosque (Golden Mosque)", "meta": {"city": "Yarkand", "type": "Mosque", "century": "16", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3962"}}]}, {"name": "Oman", "children": [{"name": "Masjid al-Jinah (Nizwa)", "meta": {"city": "Nizwa", "type": "Mosque", "century": "16", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/18994"}}]}]}, {"name": "Mamluk", "children": [{"name": "Egypt", "children": [{"name": "Al-Nasir Muhammad Mosque", "meta": {"city": "Cairo", "type": "Mosque", "century": "14C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}, {"name": "Bimaristan al-Mu'ayyidi", "meta": {"city": "Cairo", "type": "Hospital", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1527"}}, {"name": "Jami' al-Amir Aytmish al-Bajasi", "meta": {"city": "Cairo", "type": "Mosque", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2306"}}, {"name": "Madrasa Umm al-Sultan Sha'ban", "meta": {"city": "Cairo", "type": "Madrasa/Mausoleum", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2232"}}, {"name": "Madrasa and Mosque of Sultan Hasan", "meta": {"city": "Cairo", "type": "Mosque/Madrasa", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1549"}}, {"name": "Masjid Amir Qijmas al-Ishaqi", "meta": {"city": "Cairo", "type": "Mosque", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1536"}}, {"name": "Masjid Assanbugha", "meta": {"city": "Cairo", "type": "Mosque", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2367"}}, {"name": "Qalawun Complex", "meta": {"city": "Cairo", "type": "Mausoleum", "century": "13C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}, {"name": "Sultan Hassan Mosque", "meta": {"city": "Cairo", "type": "Mosque", "century": "14C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}, {"name": "Sultan al-Mu'ayyad Shaykh Complex", "meta": {"city": "Cairo", "type": "Mosque/Madrasa", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2299"}}, {"name": "Zawiyya of Zayn al-Din Yusuf", "meta": {"city": "Cairo", "type": "Zawiya", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2438"}}]}, {"name": "Lebanon", "children": [{"name": "Madrasa al-Nasiriyya (Tripoli)", "meta": {"city": "Tripoli", "type": "Madrasa", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1705"}}]}, {"name": "Syria", "children": [{"name": "Khan As'ad Pasha", "meta": {"city": "Damascus", "type": "Caravanserai", "century": "18C", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 2.6}}, {"name": "Madrasa al-Zahiriyya (Damascus)", "meta": {"city": "Damascus", "type": "Madrasa/Mausoleum", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1854"}}]}]}, {"name": "Marinid", "children": [{"name": "Algeria", "children": [{"name": "Complex of Sidi Bu Medyan", "meta": {"city": "Tlemcen", "type": "Religious complex", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/5390"}}, {"name": "Jami' Sidi Abi Hasan", "meta": {"city": "Tlemcen", "type": "Mosque", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/9170"}}]}, {"name": "Morocco", "children": [{"name": "Al-Attarine Madrasa", "meta": {"city": "Fes", "type": "Madrasa", "century": "14C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}, {"name": "Bou Inania Madrasa", "meta": {"city": "Fes", "type": "Madrasa", "century": "14C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}, {"name": "Funduq al-Jadida", "meta": {"city": "Fez", "type": "Funduq/Caravanserai", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2878"}}]}]}, {"name": "Modern", "children": [{"name": "Algeria", "children": [{"name": "El Emir Abdelkader Mosque", "meta": {"city": "Constantine", "type": "Mosque", "century": "20", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/20535"}}, {"name": "Gare d'Oran", "meta": {"city": "Oran", "type": "Railway station", "century": "20", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/14977"}}, {"name": "Grande Poste d'Alger", "meta": {"city": "Algiers", "type": "Post office (neo-Moorish)", "century": "20", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/18529"}}]}, {"name": "Pakistan", "children": [{"name": "Harsukh Residential Community & Organic Farm", "meta": {"city": "Lahore", "type": "Residential/Community", "century": "21", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/21194"}}]}, {"name": "Saudi Arabia", "children": [{"name": "Binladen Mosque", "meta": {"city": "Jeddah", "type": "Mosque", "century": "20", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/578"}}, {"name": "King Fahad National Library", "meta": {"city": "Riyadh", "type": "Library (modern)", "century": "21", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/15151"}}]}, {"name": "Tunisia", "children": [{"name": "Bab Souika Restructuring", "meta": {"city": "Tunis", "type": "Urban project", "century": "20", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/686"}}]}]}, {"name": "Modern conservation", "children": [{"name": "Afghanistan", "children": [{"name": "Shah Burj Gate Restoration (Bala Hissar)", "meta": {"city": "Kabul", "type": "Gate/Restoration", "century": "21", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/20263"}}]}]}, {"name": "Modern expansions", "children": [{"name": "Saudi Arabia", "children": [{"name": "Masjid al-Haram", "meta": {"city": "Mecca", "type": "Mosque complex", "century": "21", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/3792"}}]}]}, {"name": "Modern/Original site", "children": [{"name": "Saudi Arabia", "children": [{"name": "Qubbah Mosque (Quba)", "meta": {"city": "Medina", "type": "Mosque", "century": "21", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/548"}}]}]}, {"name": "Moorish", "children": [{"name": "Portugal", "children": [{"name": "Mertola Mosque", "meta": {"city": "Mertola", "type": "Mosque", "century": "12C", "structural_vs_decorative": 3, "spatial_depth": 2, "complexity": 2.4}}]}]}, {"name": "Mughal", "children": [{"name": "India", "children": [{"name": "Humayuns Tomb", "meta": {"city": "Delhi", "type": "Mausoleum", "century": "16C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}, {"name": "Jama Masjid Delhi", "meta": {"city": "Delhi", "type": "Mosque", "century": "17C", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 2.6}}, {"name": "Jami' Masjid (Fatehpur Sikri)", "meta": {"city": "Fatehpur Sikri", "type": "Mosque", "century": "16", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2648"}}, {"name": "Moti Masjid (Agra Fort)", "meta": {"city": "Agra", "type": "Mosque", "century": "17", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1558"}}]}, {"name": "Pakistan", "children": [{"name": "Badshahi Mosque", "meta": {"city": "Lahore", "type": "Mosque", "century": "17C", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 2.6}}, {"name": "Wazir Khan Hammam (Shahi Hammam) Conservation", "meta": {"city": "Lahore", "type": "Hammam/Bathhouse", "century": "17", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/10128"}}, {"name": "Wazir Khan Mosque", "meta": {"city": "Lahore", "type": "Mosque", "century": "17C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}]}]}, {"name": "Mughal/Conservation", "children": [{"name": "Pakistan", "children": [{"name": "Shah Burj Gate (Lahore Fort)", "meta": {"city": "Lahore", "type": "Gate/Restoration", "century": "21", "structural_vs_decorative": 1, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/20263"}}]}]}, {"name": "Nasrid", "children": [{"name": "Spain", "children": [{"name": "Alhambra", "meta": {"city": "Granada", "type": "Palace/Fortress", "century": "14", "structural_vs_decorative": 1, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2547"}}, {"name": "Alhambra – Hall of Abencerrajes", "meta": {"city": "Granada", "type": "Palace", "century": "14C", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 3.8}}, {"name": "Alhambra – Hall of Two Sisters", "meta": {"city": "Granada", "type": "Palace", "century": "14C", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 3.8}}, {"name": "Comares Palace", "meta": {"city": "Granada", "type": "Palace", "century": "14C", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 3.8}}, {"name": "Mexuar (Alhambra)", "meta": {"city": "Granada", "type": "Palace hall", "century": "14", "structural_vs_decorative": 1, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/17996"}}, {"name": "Palacio de Comares", "meta": {"city": "Granada", "type": "Palace", "century": "14", "structural_vs_decorative": 1, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2549"}}, {"name": "Palacio de los Leones (Court of the Lions)", "meta": {"city": "Granada", "type": "Palace", "century": "14", "structural_vs_decorative": 1, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2548"}}]}]}, {"name": "Ottoman", "children": [{"name": "Bosnia and Herzegovina", "children": [{"name": "Gazi Husrev-beg Mosque", "meta": {"city": "Sarajevo", "type": "Mosque", "century": "16", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3674"}}]}, {"name": "Saudi Arabia", "children": [{"name": "Al-Masjid an-Nabawi expansions", "meta": {"city": "Medina", "type": "Mosque", "century": "16C+", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 2.6}}, {"name": "Masjid al-Qubba (Qasr Ibrahim Mosque)", "meta": {"city": "Al-Hufuf", "type": "Mosque", "century": "16", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3791"}}]}, {"name": "Turkey", "children": [{"name": "Bayezid Paşa Camii", "meta": {"city": "Amasya", "type": "Mosque", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1865"}}, {"name": "Kasim Pasa Medresesi", "meta": {"city": "Amasya", "type": "Madrasa", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2065"}}, {"name": "Selimiye Mosque", "meta": {"city": "Edirne", "type": "Mosque", "century": "16C", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 2.6}}]}]}, {"name": "Ottoman/Local", "children": [{"name": "Yemen", "children": [{"name": "Jami' al-Sinaniyya", "meta": {"city": "Sana'a", "type": "Mosque", "century": "16", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1848"}}, {"name": "Masjid Salah al-Din", "meta": {"city": "Sana'a", "type": "Mosque/Tomb", "century": "17", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3807"}}]}]}, {"name": "Ottoman/Medieval core", "children": [{"name": "Iraq", "children": [{"name": "Jami' 'Abd al-Qadir al-Jaylani", "meta": {"city": "Baghdad", "type": "Mosque/Madrasa complex", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3849"}}]}]}, {"name": "Qajar", "children": [{"name": "Iran", "children": [{"name": "Masjid-i Imam (Tehran)", "meta": {"city": "Tehran", "type": "Mosque", "century": "19", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/18611"}}]}]}, {"name": "Qara Qoyunlu", "children": [{"name": "Turkey", "children": [{"name": "Van Ulu Camii", "meta": {"city": "Van", "type": "Mosque", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3634"}}]}]}, {"name": "Saadian", "children": [{"name": "Morocco", "children": [{"name": "Saadian Tombs", "meta": {"city": "Marrakesh", "type": "Mausoleum", "century": "16C", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 3.2}}]}]}, {"name": "Safavid", "children": [{"name": "Iran", "children": [{"name": "Ali Qapu Palace", "meta": {"city": "Isfahan", "type": "Palace", "century": "17C", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 3.2}}, {"name": "Chehel Sotoun Pavilion", "meta": {"city": "Qazvin", "type": "Palace", "century": "16C", "structural_vs_decorative": 2, "spatial_depth": 3, "complexity": 2.6}}, {"name": "Imamzadah Harun-i Vilayat", "meta": {"city": "Isfahan", "type": "Shrine/Mausoleum", "century": "16", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3904"}}, {"name": "Masjid-i Imam (Isfahan)", "meta": {"city": "Isfahan", "type": "Mosque", "century": "17", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1622"}}, {"name": "Sheikh Lotfollah Mosque", "meta": {"city": "Isfahan", "type": "Mosque", "century": "17C", "structural_vs_decorative": 3, "spatial_depth": 5, "complexity": 4.2}}]}]}, {"name": "Safavid/Qajar (complex)", "children": [{"name": "Iran", "children": [{"name": "Astanah-i Hazrat-i Ma'sumah", "meta": {"city": "Qom", "type": "Shrine", "century": "17", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1653"}}, {"name": "Imam Riza Shrine Complex", "meta": {"city": "Mashhad", "type": "Shrine complex", "century": "17", "structural_vs_decorative": 2, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1642"}}]}]}, {"name": "Samanid", "children": [{"name": "Uzbekistan", "children": [{"name": "Mazar-i 'Arab 'Ata (Tim)", "meta": {"city": "Samarkand region", "type": "Mausoleum", "century": "10", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/3942"}}]}]}, {"name": "Seljuk", "children": [{"name": "Iran", "children": [{"name": "Ardistan Mosque", "meta": {"city": "Ardistan", "type": "Mosque", "century": "12C", "structural_vs_decorative": 5, "spatial_depth": 3, "complexity": 3.8}}, {"name": "Jameh Mosque of Isfahan", "meta": {"city": "Isfahan", "type": "Mosque", "century": "11–12C", "structural_vs_decorative": 5, "spatial_depth": 4, "complexity": 4.4}}, {"name": "Mashhad-i Davazdah Imam", "meta": {"city": "Yazd", "type": "Shrine/Mosque", "century": "11", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/1688"}}]}, {"name": "Turkey", "children": [{"name": "Buruciye Medresesi", "meta": {"city": "Sivas", "type": "Madrasa", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2082"}}, {"name": "Büyük Karatay Medresesi", "meta": {"city": "Konya", "type": "Madrasa", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2050"}}, {"name": "Divrigi Great Mosque", "meta": {"city": "Divrigi", "type": "Mosque", "century": "13C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}, {"name": "Great Mosque and Hospital of Divriği", "meta": {"city": "Divriği", "type": "Mosque/Hospital", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1924"}}, {"name": "Karatay Madrasa", "meta": {"city": "Konya", "type": "Madrasa", "century": "13C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}, {"name": "Malatya Ulu Camii", "meta": {"city": "Malatya", "type": "Mosque", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2057"}}, {"name": "Mama Hatun Kümbedi", "meta": {"city": "Tercan", "type": "Mausoleum", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2089"}}, {"name": "Sultan Han (Kayseri)", "meta": {"city": "Kayseri", "type": "Caravanserai", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/4146"}}, {"name": "Yakutiye Madrasa", "meta": {"city": "Erzurum", "type": "Madrasa", "century": "14C", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.4}}, {"name": "Çifte Minareli Medrese (Erzurum)", "meta": {"city": "Erzurum", "type": "Madrasa", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/1947"}}, {"name": "Çifte Minareli Medrese (Sivas)", "meta": {"city": "Sivas", "type": "Madrasa", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/2083"}}, {"name": "Şifaiye Medresesi", "meta": {"city": "Sivas", "type": "Madrasa", "century": "13", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3585"}}]}, {"name": "Turkmenistan", "children": [{"name": "Sultan Sanjar Mausoleum", "meta": {"city": "Merv", "type": "Mausoleum", "century": "12C", "structural_vs_decorative": 5, "spatial_depth": 4, "complexity": 4.4}}]}]}, {"name": "Seljuk (core)", "children": [{"name": "Iran", "children": [{"name": "Masjid-i Jami' (Isfahan)", "meta": {"city": "Isfahan", "type": "Mosque", "century": "11", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/1621"}}]}]}, {"name": "Seljuk/Atabeg", "children": [{"name": "Iraq", "children": [{"name": "Qubba Imam al-Dur", "meta": {"city": "Samarra region", "type": "Mausoleum", "century": "11", "structural_vs_decorative": 4, "spatial_depth": 3, "complexity": 3.0, "source_url": "https://www.archnet.org/sites/3838"}}]}]}, {"name": "Seljuk/Timurid (complex)", "children": [{"name": "Iran", "children": [{"name": "Turbat-i Shaykh Jam", "meta": {"city": "Turbat-e Jam", "type": "Shrine complex", "century": "12", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 4.0, "source_url": "https://www.archnet.org/sites/3887"}}]}]}, {"name": "Shirvanshah", "children": [{"name": "Azerbaijan", "children": [{"name": "Palace of the Shirvanshahs", "meta": {"city": "Baku", "type": "Palace", "century": "15C", "structural_vs_decorative": 3, "spatial_depth": 3, "complexity": 3.0}}]}]}, {"name": "Timurid", "children": [{"name": "Afghanistan", "children": [{"name": "Herat Friday Mosque", "meta": {"city": "Herat", "type": "Mosque", "century": "15C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}, {"name": "Madrasah-i Gawhar Shad (Musalla Complex)", "meta": {"city": "Herat", "type": "Madrasa/Mausoleum", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/5415"}}, {"name": "Masjid-i Jami'-i Gawhar Shad (Musalla Complex)", "meta": {"city": "Herat", "type": "Mosque", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3935"}}, {"name": "Mazar-i Khwajah Abu Nasr Parsa", "meta": {"city": "Balkh", "type": "Mausoleum", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3941"}}, {"name": "Ziyarat-i 'Abd Allah Ansari (Gazargah)", "meta": {"city": "Herat region", "type": "Shrine complex", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3936"}}]}, {"name": "Iran", "children": [{"name": "Blue Mosque of Tabriz", "meta": {"city": "Tabriz", "type": "Mosque", "century": "15C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}, {"name": "Goharshad Mosque", "meta": {"city": "Mashhad", "type": "Mosque", "century": "15C", "structural_vs_decorative": 4, "spatial_depth": 5, "complexity": 4.6}}, {"name": "Madrasa-i Husayniyya (Yazd)", "meta": {"city": "Yazd", "type": "Madrasa", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3889"}}, {"name": "Shaykh Zayn al-Din Mausoleum", "meta": {"city": "Taybad", "type": "Mausoleum", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/1680"}}]}, {"name": "Kazakhstan", "children": [{"name": "Mausoleum of Khoja Ahmed Yasawi", "meta": {"city": "Turkistan", "type": "Mausoleum", "century": "14C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}]}, {"name": "Uzbekistan", "children": [{"name": "Ak-Saray Palace", "meta": {"city": "Shahrisabz", "type": "Palace", "century": "14C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}, {"name": "Anonymous Tomb (Shah-i Zindah, 'Anonymous I')", "meta": {"city": "Samarkand", "type": "Mausoleum", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://next.archnet.org/sites/2480"}}, {"name": "Bibi-Khanym Mosque", "meta": {"city": "Samarkand", "type": "Mosque", "century": "15C", "structural_vs_decorative": 4, "spatial_depth": 4, "complexity": 4.0}}, {"name": "Chashmai Ayyub", "meta": {"city": "Bukhara", "type": "Mausoleum/Shrine", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2112"}}, {"name": "Gur-e-Amir", "meta": {"city": "Samarkand", "type": "Mausoleum", "century": "15C", "structural_vs_decorative": 4, "spatial_depth": 5, "complexity": 4.6}}, {"name": "Gur-i Amir", "meta": {"city": "Samarkand", "type": "Mausoleum", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2127"}}, {"name": "Madrasah-i Tuman Aqa", "meta": {"city": "Samarkand", "type": "Madrasa", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3937"}}, {"name": "Maqbara-i Qusam ibn Abbas (Shah-i Zindah)", "meta": {"city": "Samarkand", "type": "Mausoleum", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2141"}}, {"name": "Maqbara-i Tuman Aqa", "meta": {"city": "Samarkand", "type": "Mausoleum/Mosque", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2150"}}, {"name": "Maqbara-i Ulugh Beg ibn Abu Sa'id", "meta": {"city": "Samarkand", "type": "Mausoleum", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3938"}}, {"name": "Maqbara-i Ulugh Sultan Begum", "meta": {"city": "Samarkand", "type": "Mausoleum", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2139"}}, {"name": "Mausoleum of 1361 (Shah-i Zindah)", "meta": {"city": "Samarkand", "type": "Mausoleum", "century": "14", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/2489"}}, {"name": "Mir-i-Arab Madrasa", "meta": {"city": "Bukhara", "type": "Madrasa", "century": "16C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}, {"name": "Ulugh Beg Madrasa", "meta": {"city": "Samarkand", "type": "Madrasa", "century": "15C", "structural_vs_decorative": 3, "spatial_depth": 4, "complexity": 3.6}}]}]}, {"name": "Timurid/Uzbek (later)", "children": [{"name": "Afghanistan", "children": [{"name": "Rawza-i Sharif", "meta": {"city": "Mazar-i Sharif", "type": "Shrine/Mosque", "century": "15", "structural_vs_decorative": 2, "spatial_depth": 5, "complexity": 5.0, "source_url": "https://www.archnet.org/sites/3939"}}]}]}, {"name": "Zayyanid", "children": [{"name": "Algeria", "children": [{"name": "Sidi Boumediene Mosque", "meta": {"city": "Tlemcen", "type": "Mosque", "century": "14C", "structural_vs_decorative": 3, "spatial_depth": 3, "complexity": 3.0}}]}]}]};

const svg = d3.select("#svg");
const stage = document.getElementById("stage");
const tip = document.getElementById("tip");
const g = svg.append("g");

const zoom = d3.zoom()
  .scaleExtent([0.35, 9])
  .on("zoom", (event) => g.attr("transform", event.transform));
svg.call(zoom);

const cluster = d3.cluster()
  .separation((a,b) => (a.parent===b.parent ? 0.55 : 0.85) / a.depth);

const root = d3.hierarchy(DATA, d => d.children);
root.each(d => {
  d.id = d.ancestors().map(a => a.data.name).reverse().join("›");
  d._children = d.children;
});

let focusIds = new Set();

// --- Country grouping (aesthetic regional tint) ---
const WEST_COUNTRIES = new Set([
  "Spain","Portugal","Morocco","Algeria","Tunisia","Libya","Egypt",
  "Syria","Lebanon","Jordan","Israel / Palestine","Palestine","Israel",
  "Turkey","Greece","Bosnia and Herzegovina","Albania","Kosovo","North Macedonia"
]);

const CENTRAL_ASIA_COUNTRIES = new Set([
  "Uzbekistan","Turkmenistan","Tajikistan","Kazakhstan","Kyrgyzstan","Afghanistan","Azerbaijan"
]);

function countryOfNode(d){
  // depth: 0 root, 1 style, 2 country, 3 building
  if (!d) return null;
  const c = d.ancestors().find(a => a.depth === 2);
  return c ? c.data.name : null;
}

function groupOfNode(d){
  const c = countryOfNode(d);
  if (!c) return null;
  if (CENTRAL_ASIA_COUNTRIES.has(c)) return "central";
  if (WEST_COUNTRIES.has(c)) return "west";
  return null;
}


function strokeW(l) {
  const depth = l.target.depth || 1;
  return Math.max(0.55, 1.8 - 0.33*depth);
}

function isLeaf(d) {
  return (!d.children && !d._children && d.depth >= 3);
}

function build() {
  const width = stage.clientWidth;
  const height = stage.clientHeight;
  const radius = Math.min(width, height) * 0.36;
  cluster.size([2*Math.PI, radius]);

  svg.attr("viewBox", [-width/2, -height/2, width, height]);

  cluster(root);

  // Links
  const links = root.links();
  const linkSel = g.selectAll("path.link").data(links, d => d.target.id);

  linkSel.enter().append("path").attr("class","link")
    .merge(linkSel)
      .attr("d", d3.linkRadial().angle(d => d.x).radius(d => d.y))
      .attr("stroke-width", d => strokeW(d))
      .style("opacity", d => focusIds.size ? ((focusIds.has(d.source.id) || focusIds.has(d.target.id)) ? 0.9 : 0.14) : 1)
      .classed("dim", d => focusIds.size && !(focusIds.has(d.source.id) || focusIds.has(d.target.id)))
      .classed("west", d => groupOfNode(d.target)==="west")
      .classed("central", d => groupOfNode(d.target)==="central");

  linkSel.exit().remove();

  // Nodes
  const nodes = root.descendants();
  const nodeSel = g.selectAll("g.node").data(nodes, d => d.id);

  const nodeEnter = nodeSel.enter().append("g")
    .attr("class","node")
    .attr("transform", d => `rotate(${(d.x*180/Math.PI)-90}) translate(${d.y},0)`)
    .on("click", (event, d) => { event.stopPropagation(); toggle(d); })
    .on("mousemove", (event, d) => showTip(event, d))
    .on("mouseleave", hideTip);

  nodeEnter.append("circle");
  nodeEnter.append("rect").attr("class","bar-bg");
  nodeEnter.append("rect").attr("class","bar");

  nodeEnter.append("text")
    .attr("class","label")
    .attr("dy","0.31em")
    .text(d => d.data.name);

  const nodeMerged = nodeEnter.merge(nodeSel)
    .attr("transform", d => `rotate(${(d.x*180/Math.PI)-90}) translate(${d.y},0)`);

  nodeMerged
    .classed('west', d => groupOfNode(d)==='west')
    .classed('central', d => groupOfNode(d)==='central')
    .classed('country', d => d.depth===2);


  nodeMerged.select("circle")
    .attr("r", d => d.depth===0 ? 5 : (d.children ? 3.2 : 2.5))
    .style("opacity", d => {
      if (!focusIds.size) return 0.85;
      return focusIds.has(d.id) ? 0.95 : 0.12;
    });

  // Bars (leaf nodes only)
  const maxBar = 34, barH = 6, barGap = 8;

  nodeMerged.select("rect.bar-bg")
    .attr("rx", 3).attr("ry", 3)
    .style("display", d => isLeaf(d) ? null : "none")
    .attr("width", maxBar).attr("height", barH)
    .attr("x", d => d.x < Math.PI ? barGap : -(barGap + maxBar))
    .attr("y", -barH/2)
    .style("opacity", d => focusIds.size ? (focusIds.has(d.id) ? 0.35 : 0.08) : 0.18);

  nodeMerged.select("rect.bar")
    .attr("rx", 3).attr("ry", 3)
    .style("display", d => isLeaf(d) ? null : "none")
    .attr("height", barH)
    .attr("x", d => d.x < Math.PI ? barGap : -(barGap + maxBar))
    .attr("y", -barH/2)
    .attr("width", d => {
      const c = d.data.meta && d.data.meta.complexity != null ? +d.data.meta.complexity : null;
      if (c == null || isNaN(c)) return 0;
      const t = Math.max(0, Math.min(5, c));
      return (t/5) * maxBar;
    })
    .style("opacity", d => focusIds.size ? (focusIds.has(d.id) ? 0.85 : 0.12) : 0.55);

  // Labels positioned after bar
  nodeMerged.select("text")
    .attr("x", d => {
      const extra = isLeaf(d) ? (maxBar + 6) : 0;
      return d.x < Math.PI ? (10 + extra) : (-10 - extra);
    })
    .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
    .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
    .classed("dim", d => focusIds.size && !focusIds.has(d.id))
    .style("font-weight", d => d.depth<=1 ? 780 : (d.children ? 650 : 450))
    .style("opacity", d => {
      if (!focusIds.size) return 1;
      return focusIds.has(d.id) ? 1 : 0.24;
    });

  nodeSel.exit().remove();
}

function toggle(d) {
  if (d.children) { d._children = d.children; d.children = null; }
  else { d.children = d._children; d._children = null; }
  focusIds.clear();
  build();
}

function showTip(event, d) {
  const meta = d.data.meta || null;
  let html = `<strong>${escapeHtml(d.data.name)}</strong>`;
  const path = d.ancestors().reverse().map(a => a.data.name).join(" → ");
  html += `<div style="opacity:.85">Path: ${escapeHtml(path)}</div>`;
  if (meta && Object.keys(meta).length) {
    const pills = [];
    if (meta.city) pills.push(`<span class="pill">City: ${escapeHtml(meta.city)}</span>`);
    if (meta.type) pills.push(`<span class="pill">Type: ${escapeHtml(meta.type)}</span>`);
    if (meta.century) pills.push(`<span class="pill">Century: ${escapeHtml(meta.century)}</span>`);
    if (meta.structural_vs_decorative != null) pills.push(`<span class="pill">Struct.: ${meta.structural_vs_decorative}/5</span>`);
    if (meta.spatial_depth != null) pills.push(`<span class="pill">Depth: ${meta.spatial_depth}/5</span>`);
    if (meta.complexity != null) pills.push(`<span class="pill">Complexity: ${meta.complexity}/5</span>`);
    html += `<div style="margin-top:6px">${pills.join("")}</div>`;
    if (meta.source_url) {
      html += `<div style="margin-top:8px; opacity:.9">Source: <a href="${meta.source_url}" target="_blank" rel="noreferrer">${meta.source_url}</a></div>`;
    }
  }
  tip.innerHTML = html;
  tip.style.opacity = "1";

  const padding = 14;
  const rect = stage.getBoundingClientRect();
  const x = event.clientX - rect.left + padding;
  const y = event.clientY - rect.top + padding;

  tip.style.left = Math.min(x, rect.width - tip.offsetWidth - 10) + "px";
  tip.style.top  = Math.min(y, rect.height - tip.offsetHeight - 10) + "px";
}

function hideTip() { tip.style.opacity = "0"; }

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
}

function resetView() {
  svg.transition().duration(450).call(zoom.transform, d3.zoomIdentity.translate(0,0).scale(1));
}

function setFocusByQuery(q) {
  q = q.trim().toLowerCase();
  focusIds.clear();
  if (!q) { build(); return; }

  // Expand all so search hits hidden nodes
  root.each(d => { if (d._children) { d.children = d._children; d._children = null; } });

  const hits = root.descendants().filter(d => String(d.data.name).toLowerCase().includes(q));
  hits.forEach(h => { h.ancestors().forEach(a => focusIds.add(a.id)); focusIds.add(h.id); });
  build();
}

document.getElementById("q").addEventListener("input", (e) => setFocusByQuery(e.target.value));
document.getElementById("clear").addEventListener("click", () => { document.getElementById("q").value=""; focusIds.clear(); build(); });
document.getElementById("reset").addEventListener("click", resetView);
window.addEventListener("resize", () => build());

build();
resetView();

// --- 4K Export ---
document.getElementById("export4k").addEventListener("click", function() {
  const svgNode = document.querySelector("svg");
  const serializer = new XMLSerializer();
  const svgString = serializer.serializeToString(svgNode);

  const canvas = document.createElement("canvas");
  const size = 4096;
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");

  const img = new Image();
  const blob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  img.onload = function() {
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, size, size);
    ctx.drawImage(img, 0, 0, size, size);
    URL.revokeObjectURL(url);

    const pngUrl = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = pngUrl;
    a.download = "muqarnas_radial_4k.png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  img.src = url;
});


// --- SVG Export (Vector) ---
document.getElementById("exportSVG").addEventListener("click", function() {
  const svgNode = document.querySelector("svg");
  const serializer = new XMLSerializer();
  let svgString = serializer.serializeToString(svgNode);

  // Add XML declaration
  if (!svgString.match(/^<\?xml/)) {
    svgString = '<?xml version="1.0" standalone="no"?>\n' + svgString;
  }

  const blob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "muqarnas_radial_vector.svg";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

</script>
</body>
</html>
